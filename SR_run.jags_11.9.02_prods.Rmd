---
title: "Chinook Salmon Spatial Suitability V11.9.01"
author:
- Gregory R. Jacobs^1,2^
- Russell F. Thurow^3^
- Craig W. Osenberg^4^
- Charles Petrosky^5^
- Seth J. Wenger^1^
output:
  html_document:
    df_print: paged
  word_document:
    reference_docx: CJFAS-style1.docx
---
1-River Basin Center, Odum School of Ecology, University of Georgia, Athens, GA, USA

2-Department of Natural Resources and the Environment, Cornell University, Ithaca, NY, USA

3-Rocky Mountain Research Station (emeritus), US Forest Service, Salmon ID, USA

4-Odum School of Ecology, University of Georgia, Athens, GA, USA

5-Idaho Department of Fish and Game (retired), 600 South Walnut Street, Boise, ID

```{r setup}
knitr::opts_chunk$set(message=FALSE, echo=FALSE)
set.seed(123)
```

```{r preliminaries, message=FALSE, include=FALSE}
library(tidyverse)
library(dplyr)
library(ggplot2)
library(ggpubr)
library(sf)
library(abind)
library(runjags)
require(coda)
require(MCMCvis)
library(ggmcmc)
library(HDInterval)
library(kableExtra)
library(ggdist)
library(ggsn)
```

### Salmon data

```{r data}
load("data.prep_11.5.RData")
# whats the mean and range of segment size?
  mfsr_surveyed %>% st_as_sf() %>% left_join(seg_OBSPRED_ID) %>% 
    st_drop_geometry %>% 
    group_by(isth06) %>% summarize(seglen=sum(Shape_Leng)/1000) %>%
    ungroup() %>% summarize(mean=mean(seglen), min=min(seglen), max=max(seglen))
```

```{r supporting-datasets}
# get spatial layers too
seg <- st_read(dsn="Data_supporting", layer="seg_centroid", quiet=TRUE) 
crs1 <- st_crs(seg)
wb <- st_read(dsn="Data_supporting", layer="MFSR_WBD_Dissolve", quiet=TRUE) %>% 
  st_transform(crs1)
streamline <- st_read(dsn="Data_supporting", layer="isth06", quiet=TRUE) %>% 
  st_transform(crs1)
```

### Pre-analysis figures

```{r redd-timeseries, fig.height=3, fig.width=6, echo=FALSE, message=FALSE, warning=FALSE, fig.cap="A stacked time-series plot for Middle Fork salmon River redd counts divided into segments [@isaak2006network]. The sub-panel in the upper right corner shows the distribution of pairwise Pearson's correlation coefficients among segment redd counts."}
library(ggpmisc)
mfsrtrend <- apply(data.list$y,2,sum, na.rm=T)[8:29]

seg.cor <- data.frame(Correlation=cor(t(data.list$y), use="pairwise.complete.obs")[lower.tri(cor(t(data.list$y), use="pairwise.complete.obs"))])
seg.hist<- ggplot(seg.cor, 
  aes(x=Correlation))+
  geom_histogram()+xlim(0,1) + theme_classic() + 
  theme(
  plot.title = element_blank(),
  axis.title.x = element_blank(),
  axis.title.y = element_blank())
data.seg.hist <- tibble(x = 2016, y = 2300, 
                  plot = list(seg.hist))
y1 <- mfsr7.5 %>% 
  dplyr::select(Pop, isth06, YEAR, count) %>% 
  filter(YEAR %in% c(1995:2016) & !is.na(isth06)) %>%
  group_by(isth06, YEAR) %>%
  summarize(Pop=first(Pop), count=sum(count, na.rm=TRUE))
seg.stack <- ggplot(y1, aes(YEAR, count, fill=isth06)) + 
  geom_area(position = "stack", color="black") + theme_classic() + ylab("Redds") + 
  labs(fill = "Segment") +
  ggpp::geom_plot(data=data.seg.hist, aes(x, y, label=plot, vp.width=.4, vp.height=.33))

legendmap <- ggplot() + 
  geom_sf(data=wb, fill="white") +
  geom_sf(data=streamline, color="blue") +
  geom_sf(data=seg, aes(color=isth06), size = 4) +
  geom_sf_text(data=seg, aes(label = isth06)) +
  theme_void() + 
  theme(axis.text=element_blank(), axis.title.y=element_blank(), 
    axis.title.x = element_text(color="white"), strip.text.x = element_blank()) + 
  theme(legend.position="none") + 
  xlab("`")

segmap <- ggarrange(seg.stack+theme(legend.position="none"), legendmap, widths=c(3,1))
ggsave(filename="segmap.png", plot=segmap, width=6, height=3, dpi=600, bg="white")
knitr::include_graphics("segmap.png")
```

### Hindcasting priors

We have information on abundance timeseries from index counts ($N_{(t)}$) from @brown20022000 that overlaps with our segment-specific aerial counts, $y_{(i,t)}$. We assume that the ratio of redd counts in each segment to the sum of redds counted across MFSR index reaches ($y:N$) vary by segment and among years, $ratio_{(i,t)}$. Specifically, we assume that the natural logarithm of this ratio in each year varies randomly in time around a segment-specific mean ($\rho_{(i)}$), $ln(ratio_{(i,t)}) \sim \mathrm{Normal}(\rho_{(i)}, \sigma_{\rho(i)})$. We fit the following linear regression model to estimate the ratio between $y_{(i,t)}$ and $N_{(t)}$ for all non-zero segment counts during the years 1995 - 2000, 

$$
\rho \sim X\beta + \epsilon
$$
where $X$ is a design matrix of segment indicator variables, $\beta$ is a vector comprised of an intercept term and n-1 segment-specific coefficients, and $\epsilon$ is stochastic error. We use the mean and standard error of the predictions of this model to draw $log(ratio_{(i,t)})$ values for hindcasting priors. 

For fun, here's the series of equations: 
$$
\begin{equation}
\rho_{(i,t)}=ln(y_{(i,t)}/N_{(t)}) \\
\rho_{(i,t)} \sim X\beta + \epsilon_{(i,t)} \\
log(ratio_{(i,t)}) \sim \mathrm{Normal}(\hat{\rho}_{(i)}, \sigma_{\hat{\rho}_{(i)}}) \\
log(S_{(i,t)})=log(N_{(t)})+log(ratio_{(i,t)}) 
\end{equation}
$$
where $\hat{\rho}_{(i)}$ and $\sigma_{\hat{\rho}_{(i)}}$ are the mean and prediction standard error of the log-ratio model prediction, fed to the Chinook salmon popuation model as hyperpriors on the hindcasting module. 


```{r log.S-priors}
data.list$logr
data.list$sigma.logr
data.list$log.index
```


## JAGS code

```{r runjags, echo=FALSE, message=FALSE}
#system.time( results <- run.jags(model="SR_11.9.02_bit.R", monitor=monitor.list, data=data.list, n.chains=n.chains, inits=get.inits(n.chains), burnin=burnin, sample=sample,  thin=thin, adapt=adapt, method="parallel", keep.jags.files=TRUE) ) # 1M/500k, converged!
# ...forget to save JAGS files ...
#     user    system   elapsed 
#  2753.27   1013.25 285490.89 
results <- results.jags('runjagsfiles')
```

Assess convergence.

```{r table-unconverged}
estimated.pars <- c( #estimated parameters, not derived products
  "log.b", "sigma.b.seg", "sigma.b.yr", "sigma.b.seg.yr",
  "beta.del", "sigma.del", "r.del",
  "beta.H", "r.H",
  "beta.O", "beta.T", "beta.R", #"beta.T", "beta.R.T", 
  "sigma.H", "sigma.O", "sigma.T", "sigma.p", 
  "mean.p", 
  "sigma.rho3", "mu.rho3",
  "mu.rho4", 
  "sigma.pois"
 )
res.df <- data.frame(summary(results, vars=estimated.pars, summary.iters=10000))
tab_unconverged <- res.df %>%
  filter(psrf>1.05) %>% 
  dplyr::select(Median, Lower95, Upper95, SSeff, psrf, MC.ofSD) %>%
  arrange(-psrf)
kable(tab_unconverged, format="simple", booktabs=TRUE, digits=3, caption="Table of stochastic parameters estimated by the model that have a Gelman's $\\hat{R}$ > 1.05. If the table is empty, all estimated parameters converged by this metric.")
```

Convert JAGS model output to tidy data format using package `ggmcmc`.

```{r runjags-output}
res.ggs <- ggs(as.mcmc.list(results))# %>% filter((Iteration %% 10) == 0)
res.ggs.est <- res.ggs %>%
  filter(grepl(paste(estimated.pars, collapse="|"), Parameter))
```

Assess convergence using two versions of the $\hat{R}$ metric [@gelman1992inference; @gelman2003bayesian].

Fernández-i-Marín, Xavier. 2016. “Ggmcmc: Analysis of Mcmc Samples and Bayesian Inference.” Journal of Statistical Software 70 (1): 1–20. https://doi.org/10.18637/jss.v070.i09.

Gelman, Andrew, John B. Carlin, Hal S. Stern, and Donald B. Rubin. 1995. Bayesian Data Analysis. Boca Ratón, FL: Hardcover; Chapman & Hall/CRC.

Gelman, Andrew, and Donald B Rubin. 1992. “Inference from Iterative Simulation Using Multiple Sequences.” Statistical Science, 457–72.

```{r ggs-Rhat}
pRhats <- ggs_Rhat(res.ggs, version_rhat="BDA2") + 
  geom_vline(xintercept=c(1.05, 1.1)) + ggtitle("BDA2")
pRhats
```

\newpage

##  SAR simulation

```{r simulate-SAR}
##########
# input data 
t0 <- Sys.time()
set.seed(1)
sample_iters <- sample(1:max(res.ggs$Iteration), 999)
res.b <-   res.ggs %>% filter(Iteration%in%sample_iters) %>%
  filter(grepl("^b\\[", Parameter)) %>% 
  filter(!grepl("32|31", Parameter)) %>%
  separate(Parameter, into=c("b", "i", "t"), sep="\\]|\\[|\\,",
    remove=FALSE, extra="drop", convert=TRUE) %>%
  dplyr::select(Iteration, Chain, i, t, b=value)
res.phi.sar <- res.ggs %>% filter(Iteration%in%sample_iters) %>%
  filter(grepl("phi.sar\\[", Parameter)) %>% 
  filter(!grepl("\\[2\\]|\\[1\\]", Parameter)) %>%
  separate(Parameter, into=c("phi.sar", "t"), sep="\\]|\\[|\\,",
    remove=FALSE, extra="drop", convert=TRUE) %>%
  mutate(t=t-2) %>% #convert time index to a broodyear index
  dplyr::select(Iteration, Chain, t, phi.sar=value)
siminput <- full_join(res.b, res.phi.sar)  %>% 
  mutate(R=phi.sar*b) %>% 
  rowid_to_column("index")
Sys.time()-t0
res.b <- res.phi.sar <- t0 <- NULL; gc()
 # ~ 2.4 minutes on .200

##########
# simulation parameters - based on cross-time mean SAR, no spatial component
estSAR_summary <- siminput %>%
  filter(i==1) %>%
  group_by(Iteration, Chain) %>% 
  summarize(geomeanSAR=exp(mean(log(phi.sar)))) %>% # geomean SAR by iteration
  ungroup() %>%
  median_hdci(geomeanSAR, .width=0.9)
estSAR <- pull(estSAR_summary, geomeanSAR) # median geomean SAR
simlevels <- c(estSAR, seq(0.01, 0.02, 0.002), seq(0.03, 0.06, 0.01))

##########
# simulate SAR and recruits per spawner for each brood year in each segment
## apply simulated SARs to each segment in each year in each iteration/chain
system.time(
  simulations <- expand.grid(index=siminput$index, sim=simlevels) %>% 
    as_tibble() %>%
    left_join(siminput) %>%
    mutate(x=if_else(is.na(sim),1, sim/estSAR)) %>% #multiplier for phi.sar
    mutate(sim.sar=phi.sar*x) %>%
    mutate(sim.R=sim.sar*b)
) # ~ 11.5 seconds on .200

##########
# Summarize simulations
## summarize simulated SARs: median and HDCI of geometric mean SAR by simulation
system.time(
  sim_SARs <- simulations %>% dplyr::select(sim, Iteration, Chain, t, sim.sar) %>%
    distinct() %>% 
    group_by(sim, Iteration, Chain) %>% mutate(gSAR=exp(mean(log(sim.sar)))) %>% 
    ungroup() %>%
    group_by(sim) %>% median_hdci(gSAR, .width=0.9) %>%
    ungroup()
) # ~ 8 seconds on .200
## segment geometric mean growth rate by simulation, Iteration, and Chain
system.time(
  sim_gRsegments <- group_by(simulations, sim, Iteration, Chain, i) %>%
    summarize(gR=exp(mean(log(sim.R)))) %>%
    ungroup() 
) # ~ 18 seconds on .200
## number of suitable segments by simulation, Iteration, and Chain
fmode <- function(x) {
  ux <- unique(x)
  ux[which.max(tabulate(match(x, ux)))]
}
system.time(
  sim_suitabile <- sim_gRsegments %>% mutate(suit=gR>=1) %>%
    group_by(sim, Iteration, Chain) %>%
    summarize(nsuit=sum(suit)) %>% ungroup() %>%
    group_by(sim) %>%
    median_hdci(nsuit, .width=0.9) %>%
    ungroup()
) # <1 seconds on .200
system.time(
  sim_meanmedmode <- sim_gRsegments %>% mutate(suit=gR>=1) %>%
    group_by(sim, Iteration, Chain) %>%
    summarize(nsuit=sum(suit)) %>% ungroup() %>%
    group_by(sim) %>%
    summarize(mean=mean(nsuit), median=median(nsuit), mode=fmode(nsuit)) %>%
    ungroup() %>%
    pivot_longer(mean:mode)
) # <1 seconds on .200
```

# Results

## Data summary

```{r summary-stuff}
summarystuff <- list(
  # number of redds in dataset
  redds=sum(data.list$y, na.rm=T), 
  # number of redds by year in dataset
  redds.yr=apply(data.list$y, 2, sum, na.rm=T), 
  # mean number of redds per year in 1998 - 2018
  mean.redds.yr=list(
    mean=mean(apply(data.list$y, 2, sum, na.rm=T)[8:31]),
    sd=sd(apply(data.list$y, 2, sum, na.rm=T)[8:31])
  ),
  # mean pairwise pearson correlation coefficient between segments
  meancor=mean(cor(data.frame(t(data.list$y[,8:31])), use="pairwise.complete.obs")),
  # mean pairwise pearson correlation coefficient between segments
  sdcor=sd(cor(data.frame(t(data.list$y[,8:31])), use="pairwise.complete.obs")),
  # number of female carcass ages
  fcarcasses=sum(data.list$y.age, na.rm=T),
  # number of female carcasses by age
  fcarcases.age=apply(data.list$y.age, 3, sum, na.rm=T),
  # number of female carcasses by population
  fcarcases.pop=y1.age %>% mutate(up=1*grepl("SUL|UMA|MAR|BEA",CHNLabel)) %>% 
    group_by(CHNLabel, up)%>%summarize(n=sum(n)) %>% data.frame() %>% t(),
  # populations...
  pops=y1.age %>% mutate(up=1*grepl("SUL|UMA|MAR|BEA",CHNLabel)) %>% 
    group_by(up)%>%summarize(n=sum(n)) %>% data.frame() %>% t(),
  # table of number at age for each population
  carcasstab = y1.age %>% mutate(up=1*grepl("SUL|UMA|MAR|BEA",CHNLabel)) %>% 
    group_by(up, CHNLabel, age) %>% summarize(n=sum(n)) %>% 
    pivot_wider(values_from=n, names_from=age),
  # estimated survival from McCann et al. 2020
  CSS.y.H=with(data.list, list(mean=mean(y.H, na.rm=T), 
                             sd=sd(y.H, na.rm=T), 
                             min=min(y.H, na.rm=T),
                             max=max(y.H, na.rm=T))) %>% t(),
  # estimated proportion transported from McCann et al. 2020
  p.trans=with(data.list, 
       rbind(
         list(T.sched=0,
              mean=mean(y.del[T.sched==0], na.rm=T), 
              sd=sd(y.del[T.sched==0], na.rm=T),
              min=min(y.del[T.sched==0], na.rm=T),
              max=max(y.del[T.sched==0], na.rm=T)) %>% t(),
         list(T.sched=1,
              mean=mean(y.del[T.sched==1], na.rm=T), 
              sd=sd(y.del[T.sched==1], na.rm=T),
              min=min(y.del[T.sched==1], na.rm=T),
              max=max(y.del[T.sched==1], na.rm=T)) %>% t()
       )
  )
)
summarystuff
```

## Model results

```{r results-tab, echo = FALSE}
restults_tab_pars <- paste(estimated.pars, collapse="|^")
results_tab <- 
  res.ggs %>% filter(grepl(restults_tab_pars, Parameter)) %>%
  group_by(Parameter) %>%
  median_hdci(value, .width=0.9)
kable(results_tab, format="simple", digits=3, booktabs=TRUE, caption="Table XX. Median and 90% highest density credible interval for stochastic parameters esitmates. Regression parameter indexes for beta.O refer to (in order of 1:6) (1) intercept, (2) SST, (3) UWI, (4) MJJ PDO, (5) WTT, and (6) PH. Regression parameter indexes for beta.T refer to (in order of 1:4 (1) intercept, (2) SST, (3) UWI, and (4) MJJ PDO. Regression parameter indexes for beta.del refer to (1) intercept, (2) barge schedule. Regression parameter indexes for beta.H refer to (1) intercept, (2) water transit time, and (3) number of powerhouse passages. Indexes on mean.p and sigma.p refer to PIT tag observation probabilities of (1) BON, (2) BOA, and (3) LGA.")
```

### Reproduction

#### Smolt production

```{r b-results, fig.height=4, fig.width=6, fig.cap="Posterior estimates of reach specific smolt production, along with posterior MCMC sample traces of the natural log-scale mean and standard deviation of segment smolt production rates in the MFSR."}
#"log.b", "sigma.b.seg", "sigma.b.yr", "sigma.b.seg.yr", b.seg[i]", "b[i,t]", 
pb1 <- ggs_traceplot(res.ggs, family="\\.b")
pb2 <- ggs_caterpillar(res.ggs, family="b.seg\\[", horizontal=FALSE, sort=TRUE) + 
  scale_y_discrete(breaks=paste0("b.seg[", 1:(data.list$s),"]"), 
      labels=letters[1:(data.list$s)])
bplot <- ggarrange(pb2, pb1, nrow=1)
bplot
```

```{r b-parameters}
kable(results_tab %>% filter(grepl("\\.b", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior smolt production module parameter estimates")
```

```{r birthrate, echo = FALSE, fig.width=8, fig.height=3, fig.cap="The spatial distribution and variation in the reproductive rate, $b$ (smolts per redd), and population growth potential, $\\lambda$ (redds per redd). Panel rows correspond to spatial scales, and columns to reproductive rate $b$ (first column), and growth potential $\\lambda$ (second and third columns). Panel (a) shows the median reproductive rates (dot), 90% highest density interval (thick line) and 95% highest density interval (thin line) for each spatial unit in caterpillar plot format with $b$ plotted on the x axis, and the location plotted on the y axis. Panel (b) shows the median growth potential (dot), 90% highest density interval (thick line) and 95% highest density interval (thin line) for each spatial unit in caterpillar plot format with $\\lambda$ plotted on the x axis, and the location plotted on the y axis. Panel (c) shows the approximate spatial distribution of median growth potential estimates across a map of the Middle Fork Salmon river (blue line) and its watershed (black outline), where points are scaled by color (lighter is higher) and labeled to match median and credible interval plots."}

# segment-specific cross-time geometric mean lambda by iteration and chain
system.time(
  seg.lit <- filter(sim_gRsegments, sim==estSAR) %>% 
    rename(name=i, value=gR) %>% select(-sim)%>%
  mutate(Parameter=as.factor(as.numeric(name))) %>% #hack "for ggs plots
  mutate(psize=1, isth06=letters[as.numeric(name)]) %>%
  left_join(seg, by=c("isth06")) #%>% st_as_sf()
)
# median and highest density interval of cross-time geometric mean lambda
seg.l <- seg.lit %>% 
  group_by(name) %>% median_hdci(value, .width=0.9) %>%
  mutate(isth06=letters[as.numeric(name)]) %>%
  left_join(seg.lit%>%dplyr::select(isth06, psize, geometry)%>%distinct())

# segment-specific cross-time geometric mean birthrate by iteration and chain
seg.bit <- group_by(siminput, Iteration, Chain, i) %>%
  summarize(gb=exp(mean(log(b)))) %>%
  ungroup() %>%
  rename(name=i, value=gb) %>% 
  mutate(Parameter=as.factor(as.numeric(name))) %>% #hack "for ggs plots
  mutate(psize=1, isth06=letters[as.numeric(name)]) %>%
  left_join(seg, by=c("isth06")) #%>% st_as_sf()
# mode and highest density interval of cross-time geometric mean birthrate
seg.b <- seg.bit %>% 
  group_by(name) %>% median_hdci(value, .width=0.9) %>%
  mutate(isth06=letters[as.numeric(name)]) %>%
  left_join(seg.bit%>%dplyr::select(isth06, psize, geometry)%>%distinct())

### Plots ###

# caterpillar plot of segment geomean lambdas
pl<- ggs_caterpillar(seg.lit, horizontal=TRUE, sort=TRUE) +
  xlab(expression('Growth rate'~(lambda["(i)"]))) + ylab("Segment") + 
  theme_classic() + theme(axis.text.y=element_blank()) + 
  geom_vline(xintercept=1, lty=2)
pl$data <- left_join(pl$data, seg.l%>%dplyr::select(name,isth06))
pl <- pl + geom_text(aes(x=high, label=isth06), nudge_x=.05) 

# caterpillar plot of segment geomean birth rates
pb <- ggs_caterpillar(seg.bit, horizontal=TRUE, sort=TRUE) +
  xlab(expression('Reproductive rate'~(italic(b[segment])))) + 
  ylab("Segment") + theme_classic() + theme(axis.text.y=element_blank()) 
pb$data <- left_join(pb$data, seg.b%>%dplyr::select(name,isth06))
pb <- pb + geom_text(aes(x=high, label=isth06), nudge_x=17)

# map panels
lambdabreak_seg.l <- abs(diff(c(range(seg.l$value)[1],1)))/
  diff(c(range(seg.l$value)))
pmap_l <- ggplot() +
  geom_sf(data=wb, fill="white") +
  geom_sf(data=streamline, color="blue") +
  geom_sf(data=st_as_sf(seg.l), aes(color=value), size=6) +  
  geom_sf_text(data=st_as_sf(seg.l), aes(label=isth06)) +
  scale_color_viridis_c(begin=0.1) +
  theme_void() +
  theme(axis.text=element_blank(), axis.title.y=element_blank(), 
        axis.title.x=element_text(color="white"), 
        strip.text.x=element_blank()) + 
  xlab("`") + 
  labs(color=expression(lambda)) 

#combine panels to one figure
birthrate <- ggarrange(pb, pl, pmap_l, labels=letters[1:3], ncol=3, nrow=1)
ggsave(filename="birthrate.png", plot=birthrate, width=8, height=3, dpi=600, bg="white")
knitr::include_graphics("birthrate.png")
```

Present the medians and HDI's from panels (a) and (b) in table form.

```{r birthrate-table}
btab <- bind_cols(
  mutate(seg.b, value=round(value, 1), 
         HDI.b=paste(round(.lower, 1), round(.upper, 1), sep="--")) %>% 
    select(Segment=isth06, `$b$`=value, HDI.b),
  mutate(seg.l, value=round(value, 2), 
         HDI.l=paste(round(.lower, 2), round(.upper, 2), sep="-")) %>% 
    select(`$\\lambda$`=value, HDI.l)
) %>% arrange(`$b$`)
kable(btab, format="simple", booktabs=TRUE, caption="Posterior medain and HDI of segment-specific geometric mean birth rates ($b$) and population growth potentials ($\\lambda$). ")
```


### Transport and maturation

#### Smolt Transport ($\delta$)

Priors for Beta regression coefficients ($u$ denotes the coefficient index 1:2),

$$
\begin{align}
\beta_{\delta(u)} &\sim \text{Normal}(0, \sqrt{2}) \\
\sigma_{\delta} &\sim \text{Half-Cauchy}(0, \sqrt{2}) \\
r_{\delta} &\sim \text{Half-Cauchy}(0, \sqrt{2})
\end{align}
$$

Mixed-effects Beta regression model statement and likelihood, with variation across time $t$,

$$
\begin{align}
\alpha_{\delta(c)} &\sim \text{Normal}(0, \sigma_{\delta}) \\
\text{logit}(\delta_{(t)})&= \beta_{\delta(1)} + \beta_{\delta(2)}X_{Schedule(t)} + \alpha_{\delta(t)} \\
y_{\delta(t)} &\sim \text{Beta}(r_{\delta}\delta(t), r_{\delta}(1-\delta(t)))
\end{align}
$$

```{r del-parameters}
kable(results_tab %>% filter(grepl("beta.del|sigma.del|r.del", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior smolt transport probaility module parameter estimates")
```

```{r del-results, echo=FALSE, fig.cap="Posterior estimates of year specific smolt transport probability, along with posterior MCMC sample traces of beta regression coefficients (beta.del[1], beta.del[2]), a random year effect (sigma.del), and the beta distribution shape parameter (r.del).", fig.height=4, fig.width=6, message=FALSE}
pdel1 <- ggs_traceplot(res.ggs, family="beta.del|sigma.del|r.del")
pdel2 <- ggs_caterpillar(res.ggs, family="^del\\[", horizontal=FALSE, sort=TRUE, 
  X=data.frame(Parameter=paste0("del[", 1:32, "]"), migrationyear=1988:2019)) +
  geom_line(data=covariates, aes(y=migrationyear, x=prop.trans), col="red",
    orientation="y") + ylim(1988,2019)
delplot <- ggarrange(pdel2, pdel1, nrow=1, widths=c(1,1))
delplot
```

```{r del-results-stats}
#proportion transported - all years
prop.trans.summary <- covariates %>% 
  filter(!is.na(prop.trans)) %>% 
  summarize(mean=mean(prop.trans),
            sd=sd(prop.trans),
            median=median(prop.trans),
            geomean=exp(mean(log(prop.trans))),
            minyear=min(migrationyear),
            maxyear=max(migrationyear)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="prop.trans")
#proportion transported through 2006
prop.trans.summary1 <- covariates %>% filter(migrationyear<2007) %>% 
  filter(!is.na(prop.trans)) %>% 
  summarize(mean=mean(prop.trans),
            sd=sd(prop.trans),
            median=median(prop.trans),
            geomean=exp(mean(log(prop.trans))),
            minyear=min(migrationyear),
            maxyear=max(migrationyear)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="prop.trans1")
#proportion transported from 2007 onward
prop.trans.summary2 <- covariates %>% filter(migrationyear>2006) %>% 
  filter(!is.na(prop.trans)) %>% 
  summarize(mean=mean(prop.trans),
            sd=sd(prop.trans),
            median=median(prop.trans),
            geomean=exp(mean(log(prop.trans))),
            minyear=min(migrationyear),
            maxyear=max(migrationyear)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="prop.trans2")
#estimated proportion transported summary
delta.summary <- pdel2$data %>%
  rename(median.t=median) %>% 
  summarize(median=median(median.t),
            mean=mean(median.t),
            geomean=exp(mean(log(median.t))),
            min=min(median.t),
            max=max(median.t)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="delta")
bind_rows(prop.trans.summary, prop.trans.summary1, prop.trans.summary2, 
          delta.summary) %>% select(par, value, rowname)
```


#### Maturation

The probability of maturation at age was estimated using a multinomial model to explain observed age-specific counts of female Chinook salmon as a function of life-cycle model predictions. Essentially, we assume that the distribution of carcass age counts on the spawning habitat should reflect the distribution of mature female ages that the model predicts will return to spawn, 

$$
y_{age(i,t,1:3)} \sim \mathrm{Multinomial}(\hat{p}_{age(i,t,1:3)}, n_{age(i,t)})
$$
where $i$ is one of the 8 ICTRT populations in the study area, $\hat{p}_{age(i,t,1:3)}$ is the proportional contribution of each age (1:3) to the total number of mature female fish on the spawning grounds in year $t$ across all segments within an ICTRT population sub-watershed $i$ in year $t$, and $n_{age(i,t)}$ is the number of carcasses counted in $y_{age(i,t,1:3)}$. This multinomial draw acts to inform maturation parameters and informs the partitioning of mortality risks among at-sea sources and in-river sources.

To inform this likelihood, segment $S_{(i,t)}$ were aggregated to the ICTRT population scale by location. Most segments fell completely in one ICTRT populations, but for two that fell within 2 ICTRT populations, segments were assigned to the population with most overlap in stream length. 

```{r rho-parameters}
kable(results_tab %>% filter(grepl("mu.rho3|sigma.rho3", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior smolt transport probaility module parameter estimates")
```

```{r rho, echo=FALSE, fig.height=4, fig.width=6, fig.cap="Figure of age-at-return predictions and parameters. Panel a shows the posterior median and 90% credible interval of the probability that age 3 fish return to spawn at age 4 across year. Panel b shows the samping iteration traces of parameters mu.rho3 and sigma.rho3 that control the ranodm walk equation leading to the esitmates in panel a. Panel C shows the posterior sampling density distribution of rho4, the probability that age 4 ocean fish will return to spawn at age 5. In our model, all age 5 ocean fish return to spawn at age 6."}
prho1 <- ggs_density(res.ggs, family="mu.rho3")+ 
  theme_minimal() + theme(legend.position="none", strip.text=element_blank(),
                          axis.text.y=element_blank()) +
  ylab("") + xlab(expression(mu[rho[3]]))
prho2 <- ggs_caterpillar(res.ggs, family="^rho3\\[", horizontal=FALSE, sort=FALSE, X=data.frame(Parameter=paste0("rho3[", 1:34, "]"), Year=1988:2021))  +
  ylim(1988,2019)+ 
  theme_minimal() + theme(legend.position="none", axis.text.y=element_blank())
prho3 <- ggs_density(res.ggs, family="sigma.rho3")+ 
  theme_minimal() + theme(legend.position="none", strip.text=element_blank(),
                          axis.text.y=element_blank()) +
  ylab("") + xlab(expression(sigma[rho[3]]))
prho4 <- ggs_density(res.ggs, family="^rho4") + 
  theme_minimal() + theme(legend.position="none", strip.text=element_blank(),
                          axis.text.y=element_blank()) +
  ylab("") + xlab(expression(rho[4]))
plotrho <- ggarrange(prho2, prho1, prho3, prho4, ncol=2, nrow=2, 
                     labels=letters[1:4])
plotrho
```

### Survival

#### In-river survival (H)

We modeled in-river survival of in-river (not tranported) fish using a mixed effects logistic regression model for each migration year cohort. Priors on logit-model coefficients ($u$ denotes the coefficient index 1:3), 

$$
\begin{align}
\beta_{H(u)} &\sim \text{Normal}(0, \sqrt{2}) \\
\sigma_{H} &\sim \text{Half-Cauchy}(0, \sqrt{2}) 
\end{align}
$$

Mixed-effects logistic regression model statement: for each migration year (and migration year cohort) designated by the time index $t$,

$$
\begin{align}
\alpha_{H(t)} &\sim \text{Normal}(0, \sigma_{H}) \\
\text{logit}(\phi_{H(t)}) &= \beta_{H(1)} + \beta_{H(2)}X_{WTT(t)}+ \beta_{H(3)}X_{PH(t)} + \beta_{H(4)}X_{WTT(t)}X_{PH(t)} + \alpha_{H(t)}
\end{align}
$$
     
```{r H-parameters}
kable(results_tab %>% filter(grepl("beta.H|sigma.H", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior in-river hydrosystem survival parameter estimates")
```

```{r H-results, fig.height=4, fig.width=8, fig.cap="Posterior estimates of year specific smolt survival probability during in-river passage thorugh the hydrosystem, along with posterior MCMC sample traces of beta regression coefficients (beta.H), a random year effect (sigma.H), and the beta distribution shape parameter (r.H). Red trace shows CSS estimates of in-river survival by year (McCann 2020?). Blue trace shows NOAA estimates of in-river survival by year (Widener 2018)."}
nbeta.H <- grep("beta.H",res.ggs$Parameter, value=TRUE)%>%unique()%>%length()
pH1 <- ggs_traceplot(res.ggs, family="beta.H") + 
  geom_hline(yintercept=c(-0.18, 0, 0.18), lty=rep(c(2,1,2), nbeta.H)) +
  theme(legend.position="none")
pH2 <- ggs_caterpillar(res.ggs, family="phi.H\\[", horizontal=FALSE, sort=FALSE, 
  X=data.frame(Parameter=paste0("phi.H[", 1:32, "]"), 
    migrationyear=1988:2019))  +
  geom_line(data=covariates, aes(y=migrationyear, x=survival), 
    orientation="y", col="red", size=1) + 
  geom_line(data=covariates, aes(y=migrationyear, x=TraptoBonnevilleDam), 
    orientation="y", col="blue", size=1) + 
  ylim(1988,2019) + xlim(0,1)
pH3 <- ggs_traceplot(res.ggs, family="^r.H|sigma.H")+theme(legend.position="none")
Hsubplot <- ggarrange(pH2, pH3, row=2, ncol=1)
Hplot <- ggarrange(pH2, pH1, pH3, nrow=1, widths=c(1,1), heights=c(1,1))
Hplot
```

```{r H-results-stats}
#proportion transported covariate data
survival.summary <- covariates %>%
  filter(!is.na(survival)) %>% 
  summarize(mean=mean(survival),
            sd=sd(survival),
            median=median(survival),
            geomean=exp(mean(log(survival))),
            minyear=min(migrationyear),
            maxyear=max(migrationyear)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="survival")
#estimated proportion transported summary
H.summary <- pH2$data %>%
  rename(median.t=median) %>% 
  summarize(median=median(median.t),
            mean=mean(median.t),
            geomean=exp(mean(log(median.t))),
            min=min(median.t),
            max=max(median.t)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="phiH")
bind_rows(survival.summary, H.summary) %>% select(par, value, rowname)
```

#### Ocean survival

Ocean survival was estimated separately for transported (T group) and in-river (H group) fish using mixed-effects logistic regression models. Priors on logit-model ocean survival coefficients ($u$ denotes the coefficient index 1:6), 

$$
\begin{align}
\beta_{O(u)} &\sim \text{Normal}(0, \sqrt{2}) \\
\sigma_{O} &\sim \text{Half-Cauchy}(0, \sqrt{2})
\end{align}
$$

Mixed-effects logistic regression model statement: for each migration year (and migration year cohort) designated by the time index $t$,

$$
\begin{align}
\alpha_{O(t)} \sim~& \text{Normal}(0, \sigma_{O}) \\
\text{logit}(\phi_{O(t)}) =~& \beta_{O(1)} + \beta_{O(2)}X_{SST(t)} + \beta_{O(3)}X_{UWI(t)} + \beta_{O(4)}X_{PDO(t)} + \\& \beta_{O(5)}X_{WTT(t)} + 
\beta_{O(6)}X_{PH(t)} + \alpha_{O(t)}
\end{align}
$$

The Mixed-effects logistic regression model coefficients for the T group are mostly shared with those of the H group, except for an omission of a powerhouse passages effect ($X_{PH(t)}$) and water transit time effect ($X_{WTT(t)}$), and inclusion of a group-specific random year effect ($\sigma_{T}$).

$$
\begin{align}
\sigma_{T} &\sim \text{Half-Cauchy}(0, \sqrt{2}) \\
\end{align}
$$

Mixed-effects logistic regression model statement for the T group: for each migration year (and migration year cohort) designated by the time index $t$,

$$
\begin{align}
\alpha_{T(t)} \sim ~& \text{Normal}(0, \sigma_{T}) \\
\text{logit}(\phi_{T(t)}) = ~& \beta_{T(1)} + \beta_{T(2)}X_{SST(t)} + \beta_{T(3)}X_{UWI(t)} +\beta_{T(4)}X_{PDO(t)} + \alpha_{T(t)}
\end{align}
$$

```{r O-parameters}
kable(results_tab %>% filter(grepl("beta.O\\[|sigma.O$|beta.T\\[|sigma.T", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior ocean survival parameter estimates")
```

```{r C-ocean-results, echo = FALSE, fig.width=8, fig.height=5, fig.cap="Posterior estimates of reach specific smolt production, along with posterior MCMC sample traces of the natural log-scale mean and standard deviation of segment smolt production rates in the MFSR."}
#logit(phi.del[c]) <- beta.T[1] + beta.T[2]*x.sst[c] + beta.T[3]*x.upapr[c] + beta.T[4]*x.pdomjj[c] + beta.T[5]*x.wtt[c] + alpha.T[c] 
#logit(phi.del.pred[c]) <- beta.T[1] + beta.T[2]*x.sst[c] + beta.T[3]*x.upapr[c] + beta.T[4]*x.pdomjj[c] + beta.T[5]*x.wtt[c]
map_Cvars <- data.frame(Parameter=paste0("beta.O[",1:6,"]"), variable=factor(c("Intercept", "SST", "UWI", "PDO", "WTT", "PH"), ordered=TRUE))
map_Tvars <- data.frame(Parameter=paste0("beta.T[",1:5,"]"), variable=factor(c("Intercept", "SST", "UWI", "PDO", "WTT"), ordered=TRUE))
# Covariate traces
pC1 <- ggs_traceplot(res.ggs, family="beta.O")
pC1$data <- left_join(pC1$data, map_Cvars)
pC1alt <- ggplot(pC1$data, aes(x=Iteration, y=value, color=factor(Chain))) + 
	geom_line() +
	facet_wrap(vars(variable), scales = "free_y", ncol=1) + 
	geom_hline(data=data.frame(yintercept=c(-0.18,0,0.18), lty=c(2,1,2)), 
		aes(yintercept=yintercept)) + 
	theme_classic() + theme(legend.position="none") + ggtitle("in-river")
pT1 <- ggs_traceplot(res.ggs, family="beta.T")
pT1$data <- left_join(pT1$data, map_Tvars)
pT1alt <- ggplot(pT1$data, aes(x=Iteration, y=value, color=factor(Chain))) + 
	geom_line() +
	facet_wrap(vars(variable), scales = "free_y", ncol=1) + 
	geom_hline(data=data.frame(yintercept=c(-0.18,0,0.18), lty=c(2,1,2)), 
		aes(yintercept=yintercept)) + 
	theme_classic() + theme(legend.position="none") + ggtitle("transported")
# survival timeseries
pC2 <- ggs_caterpillar(res.ggs, family="phi.O\\[", horizontal=FALSE, sort=FALSE, 
  X=data.frame(Parameter=paste0("phi.O[", 1:32, "]"), 
    migrationyear=1988:2019))  +
  ylim(1988,2019) + ggtitle("in-river") +
  theme_classic() + geom_point(size=1)
pC2$layers[[1]] <- geom_point(size=2)
pC2$layers[[2]] <- geom_segment(aes(xend=high, yend=migrationyear, x=low), size=1)
pT2 <- ggs_caterpillar(res.ggs, family="phi.del\\[", horizontal=FALSE, sort=FALSE, 
  X=data.frame(Parameter=paste0("phi.del[", 1:32, "]"), 
    migrationyear=1988:2019))  +
  ylim(1988,2019) + theme_classic() + ggtitle("transported")
pT2$layers[[1]] <- geom_point(size=2)
pT2$layers[[2]] <- geom_segment(aes(xend=high, yend=migrationyear, x=low), size=1)
pC3 <- ggs_traceplot(res.ggs, family="sigma.O$|sigma.T") + theme_classic() + theme(legend.position="none")
Cplot <- ggarrange(ggarrange(pC2, pT2, ncol=1), pC1alt, pT1alt, pC3, nrow=1, widths=c(1,1))
Cplot
```

```{r ocean-survival-stats}
#estimated early ocean survival
O.summary <- pC2$data %>%
  rename(median.t=median) %>% 
  summarize(median=median(median.t),
            mean=mean(median.t),
            geomean=exp(mean(log(median.t))),
            min=min(median.t),
            max=max(median.t)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="phiO")
T.summary <- pT2$data %>%
  rename(median.t=median) %>% 
  summarize(median=median(median.t),
            mean=mean(median.t),
            geomean=exp(mean(log(median.t))),
            min=min(median.t),
            max=max(median.t)) %>%
  t() %>% data.frame(value=.) %>% rownames_to_column() %>% 
  mutate(par="phiT")
bind_rows(T.summary, O.summary) %>% select(par, value, rowname)
```

#### Adult (return) survival

We treat adult survival for T and H groups as equivalent (among groups) and temporally invariant. 

$$
\begin{align}
\beta_R &\sim \text{Normal}(0, 1/\sqrt{2}) \\
\text{logit}(\phi_{R}) &= \beta_R  
\end{align}
$$

```{r R-parameters}
kable(results_tab %>% filter(grepl("beta.R", Parameter)), format="simple", booktabs=TRUE, digits=3, caption="Posterior adult (resturn) survival parameter estimates")
```

```{r adult-survival-results, echo = FALSE, fig.width=8, fig.height=4, fig.cap="Posterior distrbution of adult Chinook salmon survival through the Columbia River hydrosystem, along with the posterior MCMC sample traces of the logit-scale mean."}
pR1 <- ggs_traceplot(res.ggs, family="beta.R")
pR2 <- ggs_density(res.ggs, family="beta.R") + 
  scale_x_continuous(labels=function(x)round(100*plogis(x),digits=1))
Rplot <- ggarrange(pR2, pR1, nrow=1, widths=c(1,1))
Rplot  
```

#### CJS survival estimation 

Parameters controlling survival between recapture occasions in this model are functions of stage and location-specific survival and mortality parameters. We specifed matrixes ($\pi$) that correspond to cohort-varying probability vectors of survival rates between recaptures in m-array CJS analyses of H and T group survivals. For each cohort, H group survival vectors were, 

$$
\begin{align}
\pi_{H(1,c)} =&~ \phi_{H(c)} \\
\pi_{H(2,c)} =&~ \phi_{O(c)} \phi_{A} \phi_{A} (1-\rho_{4(c+2)}) \phi_{A}(1-\rho_5)+ \\ 
&~\phi_{O(c)} \phi_{A} (1-\rho_{4(c+2)}) \rho_5+ \\
&~\phi_{O(c)} \phi_{A} \rho_{4(c+2)} \\
\pi_{H(3,c)} =~& \phi_{R} \\
\end{align}
$$

and T group survival vectors were

$$
\begin{align}
\pi_{T(1,c)} =& \phi_{B} \phi_{\delta(c)} \phi_{A} \phi_{A} (1-\rho_{4(c+2)}) \phi_{A}(1-\rho_5)+ \\ 
&\phi_{B} \phi_{\delta(c)} \phi_{A} (1-\rho_{4(c+2)}) \rho_5+ \\
&\phi_{B} \phi_{\delta(c)} \phi_{A} \rho_{4(c+2)} \\
\pi_{T(2,c)} =& \phi_{R}
\end{align}
$$

The survival parameters for each group in each cohort were used to explain variation in capture histories of smolts and adults at Lower Granite and Bonneville Dams in the context of a Cormack-Jolly-Seber mark-recapture study. We used data on individual Chinook salmon captured and tagged in the Salmon River prior to out-migration as smolts. We constructed capture histories for all individuals from two smolt passage groups (in-river/untransported fish, and fish transported from Lower Granite Dam to below Bonneville Dam) for all years from 2000 to 2019. We then summarized these individual capture histories into m-array format (@kery2012bayesian). The m-array is a matrix where each row $n$ is a recapture history for fish released in the $n$-th occasion.

```{r example-m-array, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|  	                | Recapture Occasion           ||                   |
|-	                |-	        |-	      |-	      |-	                |
| Release Occasion 	|2 (BON)	  |3 (BOA)  |4 (LGA) 	| Never recaptured 	|
|1 (LGR)            |576        |96       |3        |5199               |
|2 (BON)            |0          |18       |0        |558                |
|3 (BOA)            |0          |0        |84       |30                 |

Table: Table. The m-array summary of individual Salmon River Chinook salmon capture histories from the in-river group (C group) during migration year 2010. To interpret the table, the first row indicates the recapture histories for fish tagged during the first occasion, indicating that 576+96+3+5199=5874 fish were tagged during the first occasion, 576 were next observed passing the Lower Granite Dam as smolts, 96 were next observed passing Bonneville Dam as Smolts, 3 were next observed passing Bonneville Dam as adults, and 5199 fish were never re-observed. The second row indicates that of the 18+0+558=576 fish that were observed during the second occasion, 18 were observed passing Bonneville Dam as smolts, none were observed passing Bonneville Dam as adults, and 558 were never reobserved. The third row indicates that of the 84+30=114 fish that were observed during the second occasion, 84 were observed passing Lower Granite Dam as adults and 30 were never reobserved. 
"
cat(tabl)
```

Occasions are defined by passage facility and life stage mirroring the a designation commonly used for smolt-to-adult return passage data: Lower Granite Dam as smolts (LGR), Bonneville Dam as smolts (BON), Bonneville dam as adults (BOA), and Lower Granite Dam as adults (LGA). For the purposes of this mark-recapture analysis, we substitute [passage facility x life stage] for time, such that for adults of a given out-migration cohort, passage at BOA or LGA *at any age* occurs during one "occasion". 

We built 2 m-arrays that represent the recapture histories of cohorts passing Lower Granite and Bonneville dams, first as smolts and then as adults for the C group ($m_H$) and the T group ($m_T$). These m-arrays are indexed by Release occasion ($i$), recapture occasion ($j$), and migration year ($t$): $m_{(i,j,t)}$. Because transport group fish were transported past BON and were thus never observed there, T group m-array's include one less recapture occasion (2 occasions: BOA and LGA) than the H group of in-river fish (3 occasions: BON, BOA, LGA).

The expectation of the observed number of fish recaptured during each occasion as organized by the m-arrays is derived from survival parameters (defined above) and observation probability. We assumed that observation probability was generally consistent at each of the passage facilities (regardless of transport group) during our study period, with random year-to-year variation. We defined prior distributions for the logit mean observation probability ($\bar{p}_{(j)}$) and random inter-year variation ($\sigma_{\bar{p}(j)}$), 

$$
\begin{align}
\bar{p}_{(j)} \sim \text{Normal}(0, 1/\sqrt{2}) \\
\sigma_{\bar{p}(j)} \sim \text{Half-Cauchy}(0, \sqrt{2}) \\
\alpha_{\bar{p}(j,t)} \sim \text{Normal}(0, \sigma_{\bar{p}(j)})
\end{align}
$$

These combined to predict observation probability in each time and at east passage facility from 2000 onward. For the C group, 

$$
\text{logit}(p_{(j,t)}) = \bar{p}_{(j)} + \alpha_{\bar{p}(j,t)}
$$

Since observation probability at each passage facilities was assumed identical for C and T groups, but the j-th passage facility was offset for the two groups (T group lacks the BON observation group), p for the T group was defined,

$$
\begin{align}
p_{T(1,t)} = p_{(2,t)} \\
p_{T(2,t)} =  p_{(3,t)}
\end{align}
$$

Survival and observation parameters across passage facilities for each cohort can thus be used to define the multinomial probability of recapture for each release occasion (row) in m-array format.

```{r m-array-html-table, echo=FALSE, message=FALSE, warnings=FALSE, results='asis'}
tabl <- "
|  	| Recapture Occasion 	  	  	||  	|
|-	|-	|-	|-	|-	|
| Release Occasion 	| 2 	| 3 	| 4 	| Never recaptured 	|
| 1 	| $\\pi_1p_1$ 	| $\\pi_1(1-p_1)$ $\\pi_2p_2$ 	| $\\pi_1(1-p_1)$ $\\pi_2(1-p_2)$  $\\pi_3p_3$ 	| $1-\\pi_1p_1-\\pi_1(1-p_1)\\pi_2p_2-\\pi_1(1-p_1\\pi_2(1-p_2)\\pi_3p_3=1-\\sum(\\text{rel. occ 1})$ 	|
| 2 	| 0 	| $\\pi_2p_2$ 	| $\\pi_2(1-p_2)$ $\\pi_3p_3$ 	| $1-\\pi_2p_2-\\pi_2(1-p_2)\\pi_3p_3=1-\\sum(\\text{rel. occ 2})$ 	|
| 3 	| 0 	| 0 	| $\\pi_3p_3$ 	| $1-\\phi_3p_3=1-\\sum(\\text{rel. occ 3})$ 	|

Table: Table. The expected values of the entries of the m-array for a four occasion Cormack-Jolly-Seber capture-mark-recapture study, based on the underlying cohort survival vector ($\\pi$) and observation probability ($p$), and the numer of released individuals. Each row's cell probabilities comprise the multinomial distribution for each release occasion. Note that multi-line entries in cells of columns 3 and 4 are products, e.g., cell (1,3) is the product $\\pi_1(1-p_1)\\pi_2p_2$.
"
cat(tabl) # output the table in a format good for HTML/PDF/docx conversion
```

In our case, the H group analysis is a four-occasion CJS study with the cell probabilities of its m-array defined as a function of the parameters $\pi_{H(i,t)}$ and $p_{(i,t)}$ as follows, 

$$
\begin{aligned}
  P(m_{H(~,~,t)})=
  \begin{bmatrix}
    \pi_{H(1,t)}p_{(1,t)} & \pi_{H(1,t)}(1-p_{(1,t)})\pi_{H(2,t)}p_{(2,t)} & \pi_{H(1,t)}(1-p_{(1,t)})\pi_{H(2,t)}(1-p_{(2,t)})\pi_{H(3,t)}p_{(3,t)} & 1-\pi_{H(1,t)}p_{(1,t)}-\pi_{H(1,t)}(1-p_{(1,t)})\pi_{H(2,t)}p_{(2,t)}-\pi_{H(1,t)}(1-p_{(1,t)}\pi_{H(2,t)}(1-p_{(2,t)})\pi_{H(3,t)}p_{(1,t)}  \\
    0 & \pi_{H(2,t)}p_{(2,t)} & \pi_{H(2,t)}(1-p_{(2,t)})\pi_{H(3,t)}p_{(3,t)} & 1-\pi_{H(2,t)}p_{(2,t)}-\pi_{H(2,t)}(1-p_{(2,t)})\pi_{H(3,t)}p_{(3,t)} \\
    0 & 0 & \pi_{H(3,t)}p_{(3,t)} & 1-\pi_{H(3,t)}p_{(3,t)}
  \end{bmatrix}
\end{aligned},
$$

whereas the T group analysis is a three-occasion JCS study with cell probabilities of its m=array defined as a function of the parameters $\pi_{T(i,t)}$ and $p_{T(i,t)}$, 

$$
\begin{aligned}
  P(m_{T(~,~,t)})=
  \begin{bmatrix}
    \pi_{T(1,t)}p_{T(1,t)} & \pi_{T(1,t)}(1-p_{T(1,t)})\pi_{T(2,t)}p_{T(2,t)} & 1-\pi_{T(1,t)}p_{T(1,t)}-\pi_{T(1,t)}(1-p_{T(1,t)})\pi_{T(2,t)}p_{T(2,t)} \\
    0 & \pi_{T(2,t)}p_{T(2,t)} & 1-\pi_{T(2,t)}p_{T(2,t)}
  \end{bmatrix}
\end{aligned}.
$$

In order to predict the number of observed fish from each release at subsequent recapture occasion, we define the number of fish of each cohort released during each release occasion as $\sum_{j=1}^{4}(m_{H(i,j,t)})$ for the H group and $\sum_{j=1}^{3}(m_{T(i,j,t)})$ for the T group. We use these quantities to specify the multinomial likelihood of our m-arrays on a per-release-occasion (i.e., m-array row) basis for H group fish,

$$
m_{H(i,~,t)} \sim \text{Multinomial}(P(m_{H(i,~,t)}), \sum_{j=1}^{4}(m_{H(i,j,t)})),
$$

and for T group fish,

$$
m_{T(i,~,t)} \sim \text{Multinomial}(P(m_{T(i,~,t)}), \sum_{j=1}^{3}(m_{T(i,j,t)})),
$$

See above for discrepancy statistics and Bayesian P-values associated with these multinomial likelihoods. 


#### Smolt-to-adult returns

Survival and smolt transport parameters combine to produce group- and cohort-specific smolt-to-adult return survival rates (SARs) the reflect survival from downstream passage at Lower Granite Dam as smolts to upstream passage at Lower Granite Dam as adults, 

$$
\begin{align}
&SAR_{H(t)} = \prod_{i=1}^{3}\pi_{H(i,t)} \\
&SAR_{T(t)} = \prod_{i=1}^{2}\pi_{T(i,t)} \\
\phi_{SAR(t)} &= (1-\delta_{(t)})SAR_{H(t)} + \delta_{(t)}SAR_{T(t)}
\end{align}
$$

or 

$$
\begin{equation}
\phi_{SAR(t)} = (1-\delta_{(t)})\phi_{H(t)}\phi_{O(t)}\phi_{A}^3(1-\rho_{4(t+2)})(1-\rho_5)+\phi_A^2(1-\rho_{4(t+2)})\rho_5+\phi_A\rho_{4(t+2)}\phi_{R} \\ 
\times \\
\delta_{(t)}\phi_{B(t)}\phi_{\delta(t)}\phi_{A}^3(1-\rho_{4(t+2)})(1-\rho_5)+\phi_A^2(1-\rho_{4(t+2)})\rho_5+\phi_A\rho_{4(t+2)}\phi_{R} \\

\end{equation}
$$

```{r sar-covs}
sarcovs <- filter(covariates, migrationyear%in%1988:2019) %>%
  select(migrationyear ,sst.mjj, PDO.MJJ, UWI.APR, ph, wtt, wtt.extr) %>%
  mutate(wtt.best=if_else(is.na(wtt), wtt.extr, wtt))
sarcovsmeans <- sarcovs %>%
  summarise(x.sst.mjj=mean(sst.mjj, na.rm=TRUE), 
            sd.sst.mjj=sd(sst.mjj, na.rm=TRUE),
            x.PDO.MJJ=mean(PDO.MJJ, na.rm=TRUE),
            sd.PDO.MJJ=sd(PDO.MJJ, na.rm=TRUE),
            x.UWI.APR=mean(UWI.APR, na.rm=TRUE),
            sd.UWI.APR=sd(UWI.APR, na.rm=TRUE),
            x.ph=mean(ph, na.rm=TRUE),
            sd.ph=sd(ph, na.rm=TRUE),
            x.wtt=mean(wtt.best), sd.wtt.best=sd(wtt.best))
```

Summarize marginal SAR predictions. SAR predictions are marginal with respect to among-year unexplained variation. Conceptually, conditional predictions in our model would add each year's estimated unexplained deviation from the mean (v) to the prediction of the main effects only (X), $y=beta_tj \times X + v_t$, where $v_t ~ N(0, sigma)$; whereas marginal predictions in our model are unconditional on any year's unexplained effect,  $y=m_tj \times X$, and variance associated with random year effects contribute to estimates of uncertainty around the expectation.

```{r sar-vs-obs, echo = FALSE, fig.height=6, fig.width=6, fig.cap="Posterior median and 90% credible interval of smolt-to-adult survival rate (SARs) across out-migration year for in-river (C group) and transported (T group) Chinook salmon smolt passage groups, along with covariate plots. Posterior estimates are conditional on estimated random interannual variation in SAR estimates."}
# In-river SARs
sarcheckH <- covariates %>% dplyr::select(migrationyear, sar.c0) %>% 
  mutate(sar.c0=sar.c0/100) %>%
  right_join(
    ggs_caterpillar(res.ggs, family="sar.H\\[", horizontal=TRUE, sort=FALSE,
    X=data.frame(Parameter=paste0("sar.H[", 1:32, "]"), 
      migrationyear=1988:2019))$data
  )
psarH <- ggplot(sarcheckH, aes(x=migrationyear)) + 
  geom_ribbon(aes(ymin=Low, ymax=High), fill="gray70") + 
  geom_line(aes(y=median)) + geom_line(aes(y=sar.c0), color="red")+ 
  ylab("Survival Probability") + xlab("Migration year cohort") + 
  ggtitle("C group smolt to adult returns (SAR)") + 
  theme_classic()
# Transported SARs
sarcheckT <- covariates %>% dplyr::select(migrationyear, sar.t0) %>% 
  mutate(sar.t0=sar.t0/100) %>%
  right_join(
    ggs_caterpillar(res.ggs, family="sar.T\\[", horizontal=TRUE, sort=FALSE,
    X=data.frame(Parameter=paste0("sar.T[", 1:32, "]"), 
      migrationyear=1988:2019))$data
  )
psarT <- ggplot(sarcheckT, aes(x=migrationyear)) + 
  geom_ribbon(aes(ymin=Low, ymax=High), fill="gray70") + 
  geom_line(aes(y=median)) + geom_line(aes(y=sar.t0), color="red") + 
  ylab("Survival Probability") + xlab("Migration year cohort") + 
  ggtitle("T group smolt to adult returns (SAR)") + 
  theme_classic()

px.sst <- ggplot(data.frame(y=data.list$x.sst, x=1988:2019), aes(x=x,y=y)) + geom_line(group=1) + 
  ylab("SST") + xlab("Year") + theme_classic() + xlim(1988, 2020)
px.upapr <- ggplot(data.frame(y=data.list$x.upapr, x=1988:2019), aes(x=x,y=y)) + geom_line(group=1) + 
  ylab("UWI") + xlab("Year") + theme_classic() + xlim(1988, 2020)
px.pdomjj <- ggplot(data.frame(y=data.list$x.pdomjj, x=1988:2019), aes(x=x,y=y)) + geom_line(group=1) + 
  ylab("PDO") + xlab("Year") + theme_classic() + xlim(1988, 2020)
px.wtt <- ggplot(data.frame(y=data.list$x.wtt, x=1988:2019), aes(x=x,y=y)) + geom_line(group=1) + 
  ylab("WTT") + xlab("Year") + theme_classic() + xlim(1988, 2020)
px.ph <- ggplot(data.frame(y=data.list$x.ph, x=1988:2019), aes(x=x,y=y)) + geom_line(group=1) + 
  ylab("PH") + xlab("Year") + theme_classic() + xlim(1988, 2020)

sar_ts <- ggarrange(psarH, psarT, ncol=1, labels=c("a)","b)"))
sar_covs <- ggarrange(px.sst, px.upapr, px.pdomjj, px.wtt, px.ph, ncol=1)
sar_vs_obs <- ggarrange(sar_ts, sar_covs, ncol=2, widths=c(5,2))

#sar_vs_obs
```

```{r marginalsar-vs-obs, echo = FALSE, fig.height=6, fig.width=6, fig.cap="Posterior median and 90% credible interval of marginal (i.e., without the random year effect) smolt-to-adult survival rate (SARs) across out-migration year for in-river (C group) and transported (T group) Chinook salmon smolt passage groups, along with covariate plots. Posterior estimates are conditional on estimated random interannual variation in SAR estimates."}
# In-river SARs
sarcheckH.pred <- covariates %>% dplyr::select(migrationyear, sar.c0) %>% 
  mutate(sar.c0=sar.c0/100) %>%
  right_join(
    ggs_caterpillar(res.ggs, family="sar.H.pred\\[", horizontal=TRUE, sort=FALSE,
    X=data.frame(Parameter=paste0("sar.H.pred[", 1:32, "]"), 
      migrationyear=1988:2019))$data
  )
psarH.pred <- ggplot(sarcheckH.pred, aes(x=migrationyear)) + 
  geom_ribbon(aes(ymin=Low, ymax=High), fill="gray70") + 
  geom_line(aes(y=median)) + geom_line(aes(y=sar.c0), color="red")+ 
  ylab("SAR") + ylim(0, 0.05) + xlab(" ") + 
  ggtitle("In-river smolt-to-adult returns") + 
  theme_classic()
# Transported SARs
sarcheckT.pred <- covariates %>% dplyr::select(migrationyear, sar.t0) %>% 
  mutate(sar.t0=sar.t0/100) %>%
  right_join(
    ggs_caterpillar(res.ggs, family="sar.T.pred\\[", horizontal=TRUE, sort=FALSE,
    X=data.frame(Parameter=paste0("sar.T.pred[", 1:32, "]"), 
      migrationyear=1988:2019))$data
  )
psarT.pred <- ggplot(sarcheckT.pred, aes(x=migrationyear)) + 
  geom_ribbon(aes(ymin=Low, ymax=High), fill="gray70") + 
  geom_line(aes(y=median)) + geom_line(aes(y=sar.t0), color="red") + 
  ylab("SAR") + ylim(0, 0.05) + xlab("Migration year cohort") + 
  ggtitle("Transported smolt-to-adult returns") + 
  theme_classic()

sar_ts.pred <- ggarrange(psarH.pred, psarT.pred, ncol=1, labels=c("a)","b)"))
sar.pred_vs_obs <- ggarrange(sar_ts.pred, sar_covs, ncol=2, widths=c(5,2))

ggsave(filename="sar.pred_vs_obs.png", plot=sar.pred_vs_obs, width=6, height=6, 
       dpi=600, bg="white")
knitr::include_graphics("sar.pred_vs_obs.png")
```

Calculate group-specific summary statistics for H and T group SARs

```{r marginalsar-text}
#get_summary_stats(data.frame(H=psarH.pred$data$median, 
#                             T=psarT.pred$data$median))
print(paste("geomean of SAR_H =", exp(mean(log(psarH.pred$data$median)))))
print(paste("geomean of SAR_T =", exp(mean(log(psarT.pred$data$median)))))
print(paste("mean of SAR_H (1994-2018) =", psarH.pred$data %>% 
              filter(migrationyear %in% c(1994:2018)) %>% 
              pull(median) %>% mean()))
print(paste("mean of SAR_T (1994-2018) =", psarT.pred$data %>% 
              filter(migrationyear %in% c(1994:2018)) %>% 
              pull(median) %>% mean()))
print(paste("Snake River aggregate c0 mean (1994-2018) = ", 
            psarH.pred$data %>% filter(migrationyear %in%c(1994:2018)) %>% 
              summarize_at(c("sar.c0","median"),mean) %>% pull(sar.c0)))
print(paste("Snake River aggregate t0 mean (1994-2018) = ",
            psarT.pred$data %>% filter(migrationyear %in%c(1994:2018)) %>% 
              summarize_at(c("sar.t0","median"),mean) %>% pull(sar.t0)))
```

```{r marginalsar-text-2}
print(paste("mean of SAR_C (2002-2018) =", psarH.pred$data %>% 
              filter(migrationyear %in% c(2002:2018)) %>% 
              pull(median) %>% mean()))
print(paste("mean of SAR_T (2002-2018) =", psarT.pred$data %>% 
              filter(migrationyear %in% c(2002:2018)) %>% 
              pull(median) %>% mean()))
print(paste("Snake River aggregate c0 mean (2002-2018) = ", 
            psarH.pred$data %>% filter(migrationyear %in%c(2002:2018)) %>% 
              summarize_at(c("sar.c0","median"),mean) %>% pull(sar.c0)))
print(paste("Snake River aggregate t0 mean (2002-2018) = ",
            psarT.pred$data %>% filter(migrationyear %in%c(2002:2018)) %>% 
              summarize_at(c("sar.t0","median"),mean) %>% pull(sar.t0)))
```


Summary statistics of the geometric mean phi.sar (calculated as the geometric mean of phi.sar across years in each posterior iteration). The 90 % HDI ranges from .lower to .upper. 

```{r geomean-phi.sar}
filter(res.ggs, grepl("phi.sar", Parameter)) %>% 
  group_by(Iteration, Chain) %>%
  summarize(mean.phi.sar.PCT=100*(mean(value)),
            gmean.phi.sar.PCT=100*exp(mean(log(value)))) %>% 
  ungroup() %>%
  median_hdi(mean.phi.sar.PCT, gmean.phi.sar.PCT, .width=0.9)
```

```{r geomean-sar.H}
filter(res.ggs, grepl("sar.H", Parameter)) %>% 
  group_by(Iteration, Chain) %>%
  summarize(mean.sar.H.PCT=100*(mean(value)),
           gmean.sar.H.PCT=100*exp(mean(log(value)))) %>% 
  ungroup() %>%
  median_hdi(mean.sar.H.PCT, gmean.sar.H.PCT, .width=0.9)
```


```{r geomean-sar.T}
filter(res.ggs, grepl("sar.T", Parameter)) %>% 
  group_by(Iteration, Chain) %>%
  summarize(mean.sar.T.PCT=100*(mean(value)),
            gmean.sar.T.PCT=100*exp(mean(log(value)))) %>% 
  ungroup() %>%
  median_hdi(mean.sar.T.PCT, gmean.sar.T.PCT, .width=0.9)
```
```{r sarchecktab}
sarchecktab <- ggs_caterpillar(res.ggs, family="phi.sar.pred\\[", 
    horizontal=TRUE, sort=FALSE,
    X=data.frame(Parameter=paste0("phi.sar.pred[", 1:32, "]"), 
      migrationyear=1988:2019))$data %>% 
  select(migrationyear, phi.sar=median) %>% 
  left_join(select(sarcheckH.pred, migrationyear, sar.c0, sar.H=median)) %>% 
  left_join(select(sarcheckT.pred, migrationyear, sar.t0, sar.T=median))
sarchecktab
```

```{r sarchecktab-summary}
summary(sarchecktab)
```

## Model fit evaluation

```{r model-fit-statistics, echo = FALSE, fig.height=11, fig.width=4, fig.cap="Posterior predictive checks of Freeman-Tukey discrepancy statistics for redd counts and cohort-specific Cormack-Jolly-Seber (CJS) survival submodels. Panels a and b describe the discrepancy associated with the Poisson redd counts. Panels c and d describe the discrepancy assocated with the CJS models of fish that out-migrate as in-river smolts. Panels e and f describe the discrepancy associated with the CJS model of fish that are transported from Lower Granite Dam to below Bonneville Dam as out-migrating smolts."}
# Using Freeman-Tukey discrepancy
# References: Conn et al. 2018, Kery and Royle 2012, Mike Meredith's blog.
pfitfit.new <- ggs_density(res.ggs, family='fit$|fit.new$') + 
  ylab("Density") + xlab("Freeman-Tukey statistic")
pfit.Tfit.T.new <- ggs_density(res.ggs, family='fit.T|fit.new.T') + 
  ylab("Density") + xlab("Freeman-Tukey statistic")
pTobsTsim <- ggs_density(res.ggs, family='Tobs|Tsim') + 
  ylab("Density") + xlab("Freeman-Tukey statistic")

res.disc.fit <- ggs(as.mcmc.list(results), family='fit|fit.new') %>%
  pivot_wider(names_from=Parameter, values_from=value) 
P.fit <- mean(with(res.disc.fit, fit>fit.new)) %>%round(., 3)
res.disc.fit.T <- ggs(as.mcmc.list(results), family='fit.T|fit.new.T') %>%
  pivot_wider(names_from=Parameter, values_from=value) 
P.fit.T <- mean(with(res.disc.fit.T, fit.T>fit.new.T)) %>%round(., 3)
res.disc.Tobs <- ggs(as.mcmc.list(results), family='Tobs|Tsim') %>%
  pivot_wider(names_from=Parameter, values_from=value) 
P.Tobs <- mean(with(res.disc.Tobs, Tsim>Tobs)) %>%round(., 3)

ppcheckplot.Tobs <- ggplot(res.disc.Tobs, aes(y=Tsim, x=Tobs)) + 
  geom_point() + 
  ylim(min(res.disc.Tobs$Tsim,res.disc.Tobs$Tobs), 
    max(res.disc.Tobs$Tsim,res.disc.Tobs$Tobs)) + 
  xlim(min(res.disc.Tobs$Tsim,res.disc.Tobs$Tobs), 
    max(res.disc.Tobs$Tsim,res.disc.Tobs$Tobs)) + 
  geom_abline(slope=1)  + 
  ylab("Discrepancy of simulated data") +
  xlab("Discrepancy of data") +
  ggtitle("Poisson redd count discrepancy") + 
  theme_minimal() +
  annotate("text", min(res.disc.Tobs$Tobs), max(res.disc.Tobs$Tsim), 
    label=paste("P =", with(res.disc.Tobs, round(mean(Tsim>Tobs),3))), hjust=0)

ppcheckplot.fit.H <- ggplot(res.disc.fit, aes(y=fit.new, x=fit)) + 
  geom_point() + 
  ylim(min(res.disc.fit$fit.new,res.disc.fit$fit), 
    max(res.disc.fit$fit.new,res.disc.fit$fit)) + 
  xlim(min(res.disc.fit$fit.new,res.disc.fit$fit), 
    max(res.disc.fit$fit.new,res.disc.fit$fit)) + 
  geom_abline(slope=1)  + 
  ylab("Discrepancy of simulated data") +
  xlab("Discrepancy of data") +
  ggtitle("In-river CJS discrepancy") +  
  theme_minimal() +
  annotate("text", min(res.disc.fit$fit), max(res.disc.fit$fit.new), 
    label=paste("P =", with(res.disc.fit, round(mean(fit.new>fit),3))), hjust=0)

ppcheckplot.fit.T <- ggplot(res.disc.fit.T, aes(y=fit.new.T, x=fit.T)) + 
  geom_point() + 
  ylim(min(res.disc.fit.T$fit.new.T,res.disc.fit.T$fit.T), 
    max(res.disc.fit.T$fit.new.T,res.disc.fit.T$fit.T)) + 
  xlim(min(res.disc.fit.T$fit.new.T,res.disc.fit.T$fit.T), 
    max(res.disc.fit.T$fit.new.T,res.disc.fit.T$fit.T)) + 
  geom_abline(slope=1)  + 
  ylab("Discrepancy of simulated data") +
  xlab("Discrepancy of data") +
  ggtitle("Transported CJS discrepancy") +  
  theme_minimal() +
  annotate("text", min(res.disc.fit.T$fit.T), max(res.disc.fit.T$fit.new.T), 
    label=paste("P =", with(res.disc.fit.T, round(mean(fit.new.T>fit.T),3))), 
    hjust=0)

postpredplot <- ggarrange(ppcheckplot.Tobs, ppcheckplot.fit.H, ppcheckplot.fit.T,
                          labels=letters[1:3], ncol=1)
postpredplot
```



## Sensitivity of growth rate to river restoration

### Recruitment

We defined (female) spawning stock as the expected number of redds from which our redd count data were drawn ($S_{(i,t)}$) from segment $i$ in year $t$. We then defined recruits ($R_{(i,t)}$) as the number of spawning redds ever produced from parent redds in segment $i$ in broodyear $t$. Our model derives recruitment (the number of recruiting redds produced per parent redd, $\lambda_{(i,t)}$) for each segment $i$ and broodyear $t$ from estimated survival and production parameters following the equation,

$$
\lambda_{(i,t)} = \frac{S_{(i,t)}b_{(i)}\phi_{SAR(t+2)}}{S_{(i,t)}} = b_{(i)}\phi_{SAR(t+2)}
$$

```{r recruitment-mfsr, echo = FALSE, fig.height=4, fig.width=6, fig.cap="Figure of whole-basin vraiation in redd counts and recruitment for our study period. Panel a shows the posterior median and 90% credible interval of the estimated number of female spawners in the MFSR. The red line shows the observed number of redds between 1995 and 2015 (start and end dates indicated by vertical dashed lines). Panel b shows the median and 90% credible interval of the number of recruits produced during each brood year from 1989 to 2019. Note the last 3 years (an extrapolation in time beyond our data) indicate growth...this is a potential issue, since this was not observed in real life. Panel c shows annual variation in the median and 90% credible interval of estimated $\\lambda$  (recruits per spawner) for the whole MFSR. Panel d shows recruits ($R_{(i,t)}$) on the y-axis against spawners ($S_{(i,t)}$) on the x-axis, a 1:1 line (black, dashed), and a blue regression line with in blue."}
pSmfsr <- ggs_caterpillar(res.ggs, family="^Smfsr", horizontal=FALSE, 
  sort=FALSE, X=data.frame(Parameter=paste0("Smfsr[", 1:30, "]"), 
    Broodyear=1988:2017)) +
  geom_line(data=data.frame(x=apply(data.list$y, 2, sum, na.rm=T)[8:30], 
                            y=1995:2017), 
            aes(x=x, y=y), orientation="y", col="red", size=1) + 
  geom_hline(yintercept=c(1995,2016), lty=2) + 
  ggtitle("Spawners (Redds)") + coord_flip(xlim=c(0,5000))
pRmfsr <- ggs_caterpillar(res.ggs, family="^Rmfsr\\[", horizontal=FALSE, 
  sort=FALSE, X=data.frame(Parameter=paste0("Rmfsr[", 1:30, "]"), 
    Broodyear=1988:2017)) + 
  ggtitle("Recruits") + coord_flip(xlim=c(0,5000)) +
  geom_line(data=data.frame(x=apply(data.list$y, 2, sum, na.rm=T)[8:30], 
                            y=1995:2017), 
            aes(x=x, y=y), orientation="y", col="red", size=1)
pR.Smfsr <- ggs_caterpillar(res.ggs, family="^R.Smfsr\\[", horizontal=FALSE, 
  sort=FALSE, X=data.frame(Parameter=paste0("R.Smfsr[", 1:30, "]"), 
    Broodyear=1988:2017)) + 
  ggtitle("Lambda (R/S)")+
  scale_x_log10()
pRetMap <- data.frame(
  y=log(pRmfsr$data$median/pSmfsr$data$median), 
  ylo=log(pRmfsr$data$Low/pSmfsr$data$median),
  yhi=log(pRmfsr$data$High/pSmfsr$data$median), 
  x=pSmfsr$data$median, xlo=pSmfsr$data$Low, xhi=pSmfsr$data$High) %>%
  ggplot(aes(x=x,y=y)) + geom_point() + geom_smooth(method=lm) + 
    geom_errorbar(aes(ymin=ylo, ymax=yhi)) +
    geom_errorbarh(aes(xmin=xlo, xmax=xhi)) + 
  ggtitle("Apparent DD") + scale_x_log10() +
  xlab("Spawners") + ylab("log(R/S)")#+ ylim(0,20000)
SRplot <- ggarrange(pSmfsr, pRmfsr, pR.Smfsr, pRetMap, labels=letters[1:4])
SRplot
```

Now, to take a closer look at the Lambda (R/S) plot:

```{r lambda-ts-scale, echo=FALSE, fig.width=4, fig.height=2, fig.cap="Estimated MFSR basin average population growth potential ($\\lambda$) over time from 1996 through 2014. Colors denote the scale of inferece used to estimate $\\lambda$."}
# lambda timeseries scale
lambda_ts.df <- filter(res.ggs, grepl("R.Smfsr\\[", Parameter)) %>% 
  separate(col=Parameter, into=c("Parameter", "t"), sep = "\\]|\\[") %>%  
  group_by(t) %>% median_hdci(value, .width=0.90) %>%
  mutate(Year=as.numeric(t)+1987)
  
plambda_ts_scale <- 
  ggplot(lambda_ts.df, aes(y=value, x=Year)) + 
  geom_ribbon(aes(ymin=.lower, ymax=.upper), alpha=0.2) + 
  geom_line(lwd=1) + 
  ylab(expression(lambda[MFSR(t)])) + 
  geom_hline(yintercept=1) + 
  theme_classic() + scale_y_log10() + 
  scale_color_viridis_d(option = "C", direction=1, begin=0, end=.8, name="Scale")
#plambda_ts_scale
ggsave(filename="plambda_ts_scale.png", plot=plambda_ts_scale, width=4,  height=2, dpi=600)
knitr::include_graphics("plambda_ts_scale.png")
```

A quick figure of segment-specific birth rates across density. Density dependence in smolt production rate should show up as a negative relationship between these two variables, even though the result is not in the model. The solid line is the isocline where one smolt is produced per spawner. The dashed line is the isocline where 100 smolts are produced per spawner.  

```{r smolts-per-spawner, fig.width=6, fig.height=6}
# for segment x year smolt production "return map"
bitplot <- ggs_caterpillar(res.ggs, family="^b\\[", horizontal=FALSE, sort=FALSE)
bitplotdata <- bitplot$data %>% 
  separate(Parameter, into=c("Parameter", "i", "t"), sep = "\\]|,|\\[")
Sitplot <- ggs_caterpillar(res.ggs, family="^S\\[", horizontal=FALSE, sort=FALSE)
Sitplotdata <- Sitplot$data %>% 
  separate(Parameter, into=c("Parameter", "i", "t"), sep = "\\]|,|\\[")
pbRetdata <- bind_rows(bitplotdata, Sitplotdata) %>%
  pivot_wider(id_cols=c(i,t), names_from=Parameter, values_from=c(Low, median, High))
pbRetmap <- pbRetdata%>%
  #ggplot(aes(x=median_S, y=log(median_b/median_S))) + geom_point() + 
  ggplot(aes(x=median_S, y=median_b)) + geom_point() +  
          geom_smooth(method=loess) + 
  ggtitle("Smolts per spawner") +
  geom_hline(yintercept=100, lty=2) +
  scale_y_log10() +
  #scale_x_log10() + 
  facet_wrap(facets=vars(i))
pbRetmap
```

Plot time series of data against model predictions. First case, (not run) is to plot the data alongside model predictions, which are conditional on data-level variance estimates. Second, (run and displayed below) is to plot the data alongside simulations, which is to say unconditional data level predictions including random variance associated with the data-level variance term in the poisson redd count model, $\varepsilon_{(i,t)}$. 

```{r obs-vs-predicted, echo=FALSE, eval=FALSE, fig.width=6, fig.height=6}
s<-data.list$s
names.seg<-data.list$names.seg
res.pred <- ggs(as.mcmc.list(results), family="^S\\[") %>%
  group_by(Parameter) %>%
  summarize(mean=mean(value), 
            lhdi=HDInterval::hdi(value, credMass=.9)[[1]], 
            uhdi=HDInterval::hdi(value, credMass=.9)[[2]])
res.pred$y <- as.vector(t(data.list$y))
res.pred$Year <- rep(1988:2019, s)
res.pred$Seg <- as.vector(sapply(1:s, function(i) (rep(i,data.list$Y))))

predplot <- res.pred %>% filter(Seg%in%c(1:12)) %>%
  ggplot(aes(y=y, x=Year)) + 
  facet_wrap(facets=vars(Seg)) + 
  geom_ribbon(aes(ymin=lhdi, ymax=uhdi), fill="grey70", color="grey50") + 
  geom_line(aes(y=mean), color="gray30", lwd=1) + 
  geom_point(color="black", size=2) + 
  ggtitle("Mean and HDI of the expected number of redds") + theme_classic()

#save(predplot, file="Salmon2_V10.5_files/predplot_10.5H.RData")
#ggsave(filename="Salmon2_V10.5_files/predplot_10.5H.png", plot=predplot, width=6, height=6, dpi=600)
#knitr::include_graphics("Salmon2_V10.5_files/predplot_10.5H.png")
predplot
```

```{r obs-vs-predicted2, echo=FALSE, eval=FALSE, fig.width=6, fig.height=6}
predplot2 <- res.pred %>% filter(Seg%in%c(13:23)) %>%
  ggplot(aes(y=y, x=Year)) + 
  facet_wrap(facets=vars(Seg)) + 
  geom_ribbon(aes(ymin=lhdi, ymax=uhdi), fill="grey70", color="grey50") + 
  geom_line(aes(y=mean), color="gray30", lwd=1) + 
  geom_point(color="black", size=2) + 
  ggtitle("Mean and HDI of the expeceted number of redds") + theme_classic()
#save(predplot2, file="Salmon2_V10.5_files/predplot2_10.5H.RData")
#ggsave(filename="Salmon2_V10.5_files/predplot2_10.5H.png", plot=predplot2, width=6, height=6, dpi=600)
#knitr::include_graphics("Salmon2_V10.5_files/predplot2_10.5H.png")
predplot2
```

```{r obs-vs-simulated, echo=FALSE, fig.width=6, fig.height=6}
s<-data.list$s
names.seg<-data.list$names.seg
res.sim <-  ggs(as.mcmc.list(results), family="^ySim\\[") %>%
  group_by(Parameter) %>%
  summarize(mean=mean(value), lhdi=HDInterval::hdi(value, credMass=.9)[[1]], uhdi=HDInterval::hdi(value, credMass=.9)[[2]])
res.sim$y <- as.vector(t(data.list$y))
res.sim$Year <- rep(1988:2019,s)
res.sim$Seg <- as.vector(sapply(1:s, function(i) rep(i, data.list$Y)))

simplot <- res.sim %>% filter(Seg%in%c(1:12)) %>%
  ggplot(aes(y=y, x=Year)) + 
  facet_wrap(facets=vars(Seg)) + 
  geom_ribbon(aes(ymin=lhdi, ymax=uhdi), fill="grey70", color="grey50") + 
  geom_line(aes(y=mean), color="gray30", lwd=1) + 
  geom_point(color="black", size=2) + 
  ggtitle("Mean and HDI of the simulated number of redds") + theme_classic() + 
  coord_cartesian(ylim=c(1,750))

#save(simplot, file="Salmon2_V10.5_files/simplot_10.5H.png")
#ggsave(filename="Salmon2_V10.5_files/simplot_10.5H.png", plot=simplot, width=6, height=6, dpi=600)
#knitr::include_graphics("Salmon2_V10.5_files/simplot_10.5H.png")
simplot
```

```{r obs-vs-simulated2, echo=FALSE, fig.width=6, fig.height=6}
simplot2 <- res.sim %>% filter(Seg%in%c(13:23)) %>%
  ggplot(aes(y=y, x=Year)) + 
  facet_wrap(facets=vars(Seg)) + 
  geom_ribbon(aes(ymin=lhdi, ymax=uhdi), fill="grey70", color="grey50") + 
  geom_line(aes(y=mean), color="gray30", lwd=1) + 
  geom_point(color="black", size=2) + 
  ggtitle("Mean and HDI of the simulated number of redds") + theme_classic() + 
  coord_cartesian(ylim=c(1,750))

#save(simplot2, file="Salmon2_V10.5_files/simplot_10.5H.png")
#ggsave(filename="Salmon2_V10.5_files/simplot2_10.5H.png", plot=simplot2, width=6, height=6, dpi=600)
#knitr::include_graphics("Salmon2_V10.5_files/simplot2_10.5H.png")
simplot2
```

### Simulation Results

Plot spatial variation in $\lambda$ across variation in SAR to show how outside-basin mortality regime is expected to affect spatial variation in habitat suitability in the MFSR.

```{r sim-figure, fig.width=6.5, fig.height=3}
# note: only plotting through 2% SAR
nsuit <- sim_suitabile %>% filter(sim<=.02)

# a spatial point data frame of the expected suitable segments by simulation
sf.gt1 <- lapply(1:nrow(nsuit), function(x){
  seg.b %>% mutate(sim=nsuit$sim[x]) %>% slice_max(value, n=nsuit$nsuit[x])
}) %>% bind_rows() %>%
  mutate(simf=as.factor(as.numeric(as.factor(sim)))) %>%
  st_as_sf()
# locations of most likely suitable segments under each scenario  
plambdamap <-ggplot() +
  geom_sf(data=wb, fill="white") +
  geom_sf(data=streamline, color="blue") +
  geom_sf(data=sf.gt1, aes(fill=sim), shape=21, size=4) +  
  facet_wrap(~simf, nrow=1, drop=FALSE) + 
  scale_fill_viridis_c(begin=0.3, end=0.9) +
  theme_void() +
  theme(axis.text=element_blank(), 
        axis.title.y=element_blank(), 
        axis.title.x = element_text(color="white"), 
        strip.text.x = element_blank(),
        legend.position="none") +  
  xlab("`")
blankplot <- ggplot(data.frame(), aes(x=1, y=1))+theme_void()
plambdamap_space <- ggarrange(blankplot, plambdamap, nrow=1, widths=c(.7,8))

# per-simulation data for histograms
sim.k.lgt1 <- filter(sim_gRsegments, sim<=.02) %>% 
  mutate(ksim=paste(round(sim*100,2), "%"), suit=1*(gR>=1)) %>% 
  group_by(sim, Iteration, Chain) %>% 
  summarize(lgt1=sum(suit))
sim.pts <- sim_meanmedmode %>% filter(sim<=.02) %>%
  mutate(ksim=paste0("SAR=", round(sim*100,2), "%")) %>%
  filter(name=="median")
# histograms of the posterior distributions of number of suitable segments/sim
sim.k.histograms <- sim.k.lgt1 %>% 
  mutate(ksim=paste0("SAR=", round(sim*100,2), "%")) %>%
  #mutate(ksim=factor(paste(k,"%"), levels=paste(1:10, "%"), ordered=TRUE)) %>%
  ggplot(aes(y=lgt1,  x =..density.., fill=sim)) + 
  geom_histogram(binwidth=1, color="grey20") + 
  geom_point(data=sim.pts, aes(y=value, x=0.05, shape=name), size=2) +
  facet_wrap(vars(ksim), nrow=1, scales="fixed") +
  scale_fill_viridis_c(begin=0.3, end=0.9) +
  ylab(expression(paste("Number ", ~lambda[(i)], " > 1"))) + 
  xlab("Probability") + theme_classic() +
  theme(panel.spacing=unit(1, "lines"), strip.background=element_blank()) +
  theme(legend.position="none") +  
  scale_x_continuous(breaks=c(0,0.50)) 

pgt1 <- ggarrange(plambdamap_space, sim.k.histograms, nrow=2, heights=c(1.5,2.5))
ggsave(filename="pgt1.png", plot=pgt1, width=6.5, height=3, dpi=600, bg="white",)
knitr::include_graphics("pgt1.png")
```

```{r sim-figure-alt, fig.cap="The predicted number and location of suitable river segments for Chinook salmon production in the MFSR under dam removal scenarios. The horizontal bar plots indicate posterior distributions of the number of MFSR river segments (out of 23 total) with a median population growth rates above replacement ($\\lambda$>1), under scenarios varying SAR from 1% (left-most panel) to 2% (right-most panel). The median of each distribution is indicated by a black dot. The mode of each distribution, which is the most likely number of segments with growth rates above replacement, is the largest bar. Map plots indicate the most likely locations of the median number of productive segments per simulation."}
# when indicating simulations, call the "contemporary" simulation SAR=0.74 to match the estimate from the model, not the subset from the simulation. 
simSARlab <- c("SAR=0.74%", sim.pts$ksim[2:length(sim.pts$ksim)])

#then some colors to assign
birthratecolors <- data.frame(isth06=seg.l$isth06, 
                              col=colourvalues::colour_values(seg.l$value)) #Viridis
                              #col="black")
plambdamap_colorramp <- rep("white", 7) # gray
#plambdamap_colorramp <- scales::viridis_pal(option="C")(7) #Plasma
#plambdamap_colorramp <- scales::viridis_pal()(7) #Viridis
#plambdamap_colorramp <-RColorBrewer::brewer.pal(n=7, "YlGnBu")[7:1] # Blue to yellow
#plambdamap_colorramp <-RColorBrewer::brewer.pal(n=7, "Reds") # REds
#plambdamap_colorramp <-RColorBrewer::brewer.pal(n=8, "Greens")[1:7] # Greens
plambdamap_list <- lapply(1:7, function(i){
  sf.gt1 %>% filter(simf==i) %>% left_join(birthratecolors) %>% ggplot() +
  geom_sf(data=wb, fill="white") +
  geom_sf(data=streamline, color="light blue") +
  geom_sf(shape=19, size=3, aes(color=col)) +
  theme_void() + scale_color_identity() +
  ggtitle(paste(simSARlab[i]))  +
  theme(axis.text=element_blank(), 
        axis.title.y=element_blank(), 
        axis.title.x = element_text(color="white"), 
        strip.text.x = element_blank(),
        legend.position="none",
        plot.title=element_text(size=8, hjust=0.5)) +  
  xlab(" ")
})
simhist_list <- lapply(1:7, function(i){
  sim.k.lgt1 %>% ungroup() %>%
  mutate(simf=dense_rank(sim)) %>% 
  filter(simf==i) %>%
  #mutate(ksim=factor(paste(k,"%"), levels=paste(1:10, "%"), ordered=TRUE)) %>%
  ggplot(aes(y=lgt1,  x =..density..)) + 
  geom_histogram(binwidth=1, color="grey20", fill=plambdamap_colorramp[i]) + 
  geom_point(data=sim.pts[i,], aes(y=value, x=0.05, shape=name), size=2) +
  ylab(expression(paste("Number ", ~lambda[(i)], " > 1"))) + 
  xlab("Probability") + theme_classic() +
  theme(legend.position="none") +  ylim(0,23.5) +
  scale_x_continuous(breaks=c(0,0.5), limits=c(0,0.8)) 
})
# LIst of combined plots
cpcombolist <- lapply(1:7, function (i){
cowplot::ggdraw()+ 
  cowplot::draw_plot(simhist_list[[i]]+
                       rremove("ylab") + rremove("xlab")) +
  cowplot::draw_plot(plambdamap_list[[i]], 
                     x = .4, y = 0.05, width=0.6, height = .7) 
})

pgt1_alt <- ggarrange(plotlist=cpcombolist[2:7], nrow=1, ncol=6, 
                      labels=paste0(letters[1:6], ")"))
pgt1_alt2 <- annotate_figure(pgt1_alt, 
                             left=textGrob(expression(paste("Number ", ~lambda[(i)], " > 1")), 
                                           rot = 90, vjust=1, gp=gpar(cex=1)),
                             bottom=textGrob("Probability", gp=gpar(cex = 1)))
ggsave(filename="pgt1_alt.png", plot=pgt1_alt2, width=8, height=2.25, dpi=600, bg="white")
knitr::include_graphics("pgt1_alt.png")
```
Depending on the estimated SAR, it might be more striking to see the initial panel, and maybe we don't need to see the last pane.

```{r yet-another-alt}
pgt1_alt_alt <- ggarrange(plotlist=cpcombolist[1:6], nrow=1, ncol=6, 
                      labels=paste0(letters[1:6], ")"))
pgt1_alt_alt2 <- annotate_figure(pgt1_alt_alt, 
                             left=textGrob(expression(paste("Number ", ~lambda[(i)], " > 1")), 
                                           rot = 90, vjust=1, gp=gpar(cex=1)),
                             bottom=textGrob("Probability", gp=gpar(cex = 1)))
ggsave(filename="pgt1_alt_alt.png", plot=pgt1_alt_alt2, width=8, height=2.25, dpi=600, bg="white")
knitr::include_graphics("pgt1_alt_alt.png")
```


These results reflect the results of birth rate and survival simulations applied specifically to the MFSR to ask a question about suitability. However, our model asserts a multiplicative relationship between density independent birth rates (smolt production) and survival to reproduction (SARs) in a semelparous species. Because of this, we can create a continuous surface plot of lambda to show how population growth might vary as a function of birth rates and survival.

```{r p23-sim}
#all segments were viable in `x` out of `n` posterior sampling iterations in the final model
p23 <- group_by(sim.k.lgt1, sim) %>% summarize(x=sum(lgt1>22), n=n(), p23=x/n)
kable(p23, format="simple", booktabs=TRUE, caption="The prevalence of simulations predicting population viability ($\\lambda$>1) for all 23 segments by simulation.")
```

```{r response-surface, fig.cap="A response surface plot of population growth rate ($\\lambda$) across smolt production rate ($b$) and Smolt-to-adult return ($\\phi_{SAR}$). Color indicates population growth rate, and the black contour line indicates an isocline of zero net population growth ($\\lambda$=1). The median segment-specific birth rates observed in this study are plotted in white points at the x-axis value equal to the median of the posterior distribution of geometric mean $\\phi_{SAR}$. This plot is a general depiction of density-independent population growth rate (or, growth rate at low density) as a function of births and deaths under the assumption that $b$ comprises all births, and $\\phi_{SAR}$ comprises all deaths."}
median_sar <- sim_SARs[1,]
sardat <- data.frame(
  segment=pb$data$isth06,
  parameter=pb$data$Parameter,
  b=pb$data$median, 
  sar=rep(median_sar$gSAR, length(pb$data$median)),
  lambda=rep(1, length(pb$data$median)))

surfaceplot.df <- expand.grid(b=0:200, sar=seq(0, 0.06, length.out=250)) %>% 
  mutate(lambda=b*sar)
#plot surface
surfaceplot <- ggplot(surfaceplot.df, aes(x=sar, y=b)) + 
  geom_raster(aes(fill=lambda)) + 
  geom_contour(aes(z=lambda), breaks=1, color="black", lwd=1) + theme_minimal() +
  scale_fill_viridis_c() +
  labs(fill=expression(lambda)) + 
  ylab(expression('Smolt production rate'~(italic(b)))) +
  xlab(expression('Smolt-to-adult return survival'~(phi[SAR]))) +
  geom_point(data=sardat, aes(x=sar, y=b), color="white") +
  geom_text(data=sardat, aes(x=sar, y=b, label=segment), 
            hjust = 0, size=3, nudge_x=0.0005, color="white", 
            check_overlap=TRUE)

#ggsave(filename="surfaceplot.png", plot=surfaceplot, width=6, height=4, 
#       dpi=600, bg="white")
#knitr::include_graphics("surfaceplot.png")
```


```{r response-surface-alt}
#surfaceplot.df <- expand.grid(b=0:200, sar=seq(0, 0.06, length.out=100)) %>% 
#  mutate(lambda=b*sar)
sardat2 <- sardat %>% mutate(sar=.02)
arrowdf <- data.frame(b=c(100, 100), sar=c(.01, .019))
#plot surface
surfacebreak_seg.l <- abs(diff(c(range(surfaceplot.df$lambda)[1],1)))/
  diff(c(range(surfaceplot.df$lambda)))
surfaceplot_alt <- ggplot(surfaceplot.df, aes(x=sar, y=b)) + 
  geom_raster(aes(fill=lambda)) + 
  geom_contour(aes(z=lambda), breaks=1, color="black", lwd=.5, lty=3) + 
  theme_minimal() +
  #scale_fill_viridis_c() +
  scale_fill_gradientn(
    colors = c("#b2182b", "white", "#2166ac"),
    values = c(0, surfacebreak_seg.l, 1)
  ) +
  labs(fill=expression(lambda)) + 
  ylab(expression('Smolt production rate'~(italic(b)))) +
  geom_point(data=sardat, aes(x=sar, y=b), color="black") + 
  geom_point(data=sardat2, aes(x=sar, y=b), shape=1, color="gray30") + 
  geom_segment(aes(x=.01, y=100, xend=.019, yend=100), 
               arrow=arrow(length=unit(.25, "cm")))+
  xlab(expression('Smolt-to-adult return survival'~(phi[SAR]))) 

ggsave(filename="surfaceplot_alt.png", plot=surfaceplot_alt, width=6, height=4, 
       dpi=600, bg="white")
knitr::include_graphics("surfaceplot_alt.png")
```


fin

```{r testjags}
testjags()
```

```{r sessionInfo}
sessionInfo()
```
